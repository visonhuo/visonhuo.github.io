---
title: "微服务架构中的消息通信方式"
date: 2022-02-20T15:50:53+08:00
lastmod: 2022-02-20T15:50:53+08:00
draft: true
author: visonhuo
description: "该文章将介绍在微服务架构中，通过应用消息队列可以实现的 5 种消息模式。"
featuredImage: "/images/feature/architecture_design/message_pattern_bg.png"
featuredImagePreview: "/images/feature/architecture_design/message_pattern_bg.png"
categories: ["架构设计"]
tags: ["微服务", "消息队列"]
---
<!--more-->
## 前言
在微服务架构中，通过消息在服务间进行异步通信是一种惯用的应用模式。
也正是因为这种模式过于普及，导致我们很容易忽略消息的其他使用方法。
所以在这篇文章中，我们将会介绍使用消息机制能在微服务架构中实现的几种应用模式，
将会探讨如下主题：
- [x] 消息通信的交互模式
- [ ] 5 种消息应用模式
- [ ] 命令消息和事件消息

## 消息通信的交互模式
通常情况，当我们讲到进程间通信，大多数人的第一反应就是 **RPC（Remote Procedure Call）** 。
其实这也没错，RPC 确实是最符合我们直观感受的进程间通信。
但如果我们把进程间通信的概念再拓宽一下，其实异步地消息投递也属于进程通信的一种，
通信的本质在于信息的传递，消息投递自然也属于这一范畴。

进程间通信的过程其实很好理解，其中必然涉及两个角色：生产端和消费端。
生产端产生消息，并且通过某些手段（如远程调用、消息队列传递等）将消息传递给消费端。
在这个交互流程中包含三个交互选择来决定其工作方式：
1. 生产端发送的请求消息是否需要回复？
2. 生产端在发送完消息后是否需要等待回复？（同步 or 异步？）
3. 存在一个还是多个消费者端？（一对一 or 一对多）

通过以上三个变量可以组合出所有常规的进程间通信模式。比如 RPC 的通信交互方式：
1. 需要消费端（服务提供者端）回复信息；
2. 生产端（服务消费者端）发送请求消息之后需要等待回复；
3. 通常只存在一个消费者端；

通过组合以上列举的三个维度，我们可以将交互方式总结为以下 5 种：
|    |**一对一**|**一对多**｜
|:------:|:------:|:-------:|
|**同步模式**|请求/响应| 广播请求/响应 |
|**异步模式**| 异步请求/响应（有回复） <br /> 单向通知（无回复） | 发布/订阅（无回复） |

消息传递其实是最抽象的一种表示，只要我们有传递消息的能力，
我们便能通过调整生产端和消费端的行为来实现以上的 5 种交互模式。
接下来我们会逐个对这些模式进行介绍。

## 5 种消息应用模式
### 请求/响应模型
{{< image src="https://i.bmp.ovh/imgs/2022/02/3590de50989105f5.png" caption="同步请求 + 等待响应 + 单个消费者" >}}

这种便是典型的 RPC 模式。是的，通过消息队列我们同样可以实现 RPC 的工作方式，其中的关键点在于：
1. 在生产端发送请求时，在消息中指定消费者端回复的队列 + 消息标识ID；
2. 消费端处理完消息，在回复信息中放置请求消息标识ID，并将其发往指定的回复队列；
3. 生产端收到消息后，便能将请求和回复对应起来；

将这套方案放在生产环境中则还需要考虑很多细节，但确实是可行的。
在之前的工作中，我们确实有部门是通过消息队列的方式来实现 RPC 。
这种方式的好处在于：
1. 统一组件, 不需要单独维护另一套 RPC 组件了，通过消息队列能满足多种交互模式；
2. 传递可用性高, 生产端和消费者端不需要同时在线，允许短暂的节点失效；

当然，缺点也同样明显：
1. 热点组件，消息队列承担了所有的交互职责，需要队列组件本身具备高性能、高可用性；
2. 延迟高，因为请求消息、回复消息都需要经过队列再投递到对端，一次请求的延迟自然比点对点的 RPC 通信高得多，尤其是系统负载高时更为明显；

### 异步请求/响应模式



### 单向通知模式

### 发布/订阅模式

### 广播请求/响应模式


## 命令消息和事件消息

## 小结

## Reference
